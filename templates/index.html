{% extends 'base.html' %}

{% block content %}
<div class="dashboard-container">
    <div class="menu-icon" onclick="toggleSidebar()">
        <span class="material-icons">menu</span>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="logo-text">BloodFlow ü©∏</h1>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showSection('home')">
                <span class="material-icons">home</span> Home
            </a>
            <a href="#" class="nav-item" onclick="showSection('history'); loadDonationHistory()">
                <span class="material-icons">history_toggle_off</span> Donation History
            </a>
            <a href="#" class="nav-item" onclick="showSection('appointment')">
                <span class="material-icons">calendar_month</span> Book Appointment
            </a>
            <a href="#" class="nav-item" onclick="showSection('booked_appointments'); loadBookedAppointments()">
                <span class="material-icons">assignment</span> Booked Appointments
            </a>
            <a href="{{ url_for('login') }}" class="nav-item logout"> 
            <span class="material-icons">logout</span> Logout
        </a>
        </nav>
    </aside>

    <main class="content" id="content">
        <section id="home" class="section active-section">
            <h2 class="section-title">Dashboard Overview</h2>
            <div class="card welcome-card">
                <h3 class="card-title">üëã Welcome, <span class="highlight">{{ session['username'] }}!</span></h3>
                <div class="info-grid">
                    <div class="info-block">
                        <span class="info-label">Your Blood Group:</span>
                        <p class="info-value blood-group">{{ session['blood_group'] }}</p>
                    </div>
                    <div class="info-block">
                        <span class="info-label">Last Donation Date:</span>
                        <p class="info-value date-value" id="last_donation_date">Loading...</p>
                    </div>
                    <div class="info-block next-eligible">
                        <span class="info-label">Next Eligible Date:</span>
                        <p class="info-value date-value" id="next_eligible_date">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="history" class="section hidden">
            <h2 class="section-title">üìú Donation History</h2>
            <div class="card data-card">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Blood Bank</th>
                                <th>City</th>
                                <th>Blood Group</th>
                            </tr>
                        </thead>
                        <tbody id="donation_history_body">
                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="appointment" class="section hidden">
            <h2 class="section-title">üìÖ Book an Appointment</h2>
            <div class="card form-card">
                <h3 class="card-subtitle">Step 1: Basic Information</h3>
                <form id="appointmentForm" class="styled-form">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}

                    <p class="form-info"><strong>Your Blood Group:</strong> <span class="highlight">{{ session['blood_group'] }}</span></p>

                    <label for="medical_history" class="form-label">Medical History (Optional):</label>
                    <textarea name="medical_history" id="medical_history" rows="3" class="form-textarea" placeholder="Enter any relevant medical history"></textarea>

                    <label for="city" class="form-label">Location (City or Pincode):</label>
                    <input type="text" name="city" id="city" class="form-input" placeholder="e.g., New Delhi or 110001" required>

                    <button type="submit" class="btn btn-primary">Find Blood Banks</button>
                </form>
            </div>

            <div id="bloodbanks_section" class="card form-card hidden">
                <h3 class="card-subtitle">Step 2: Select a Blood Bank</h3>
                <form id="select_timeslot_form" class="styled-form">
                    <label for="bloodbank" class="form-label">Available Blood Banks:</label>
                    <select name="bloodbank" id="bloodbank" class="form-select" required>
                        <option value="" disabled selected>Select a blood bank...</option>
                    </select>

                    <button type="submit" class="btn btn-secondary">Continue to Time Slots</button>
                </form>
            </div>

            <div id="timeslots_section" class="card form-card hidden">
                <h3 class="card-subtitle">Step 3: Select Date and Time</h3>
                <form id="confirm_appointment_form" class="styled-form">
                    <label for="appointment_date" class="form-label">Select Date:</label>
                    <input type="date" name="appointment_date" id="appointment_date" class="form-input" required>
                    <p id="date_error" class="error-message" style="display: none;">‚ùó Please select a valid date (from today up to 10 days ahead).</p>

                    <label for="timeslot" class="form-label">Available Time Slots:</label>
                    <select name="timeslot" id="timeslot" class="form-select" required>
                        <option value="" disabled selected>Select a time slot...</option>
                    </select>

                    <button type="submit" class="btn btn-success">Confirm Appointment</button>
                </form>
            </div>
        </section>

        <section id="booked_appointments" class="section hidden">
            <h2 class="section-title">üìã Your Booked Appointments</h2>
            <div class="card data-card">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time Slot</th>
                                <th>Blood Bank</th>
                                <th>City</th>
                                <th>Status</th>
                                <th>Receipt</th>
                            </tr>
                        </thead>
                        <tbody id="appointments_table_body">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}